# 第七章 权重生成与评价模型

代码查看 evaluation.py

## 7.1 层次分析法

层次分析法（Analytic Hierarchy Process, AHP）是美国运筹学家匹茨堡大学教授萨蒂于20世纪70年代初提出的一种评价策略。这种策略虽然带有*一定主观性*，但非常奏效，也是在社会科学研究中经常使用的一类方法。

层次分析的想法简述：层次分析法是依托于比较的方案，一定要有多个方案，才能进行比较。比较不同的方案需要有相应的支点，所以选择指标很重要。类似买东西的适合要通过多个维度（价格，寿命等）考察一个商品的好坏。多个评价指标之间是相互关联的，甚至可以有**上下层级**的指标。

评级指标的权重确认一般采用 Delphi 法进行指标权重的确定。

AHP 的主要思想是：通过分析复杂系统的有关要素及相互关系，把问题简化为多层次的梯阶层次结构，自上而下分别为目标层、准则层和措施层。在该层次结构中,下层元素受上层元素控制，通过两两比较的方法建立判断矩阵，并通过一致性检验步骤检查判断矩阵的合理性，最终确定下层元素对于上层元素的权重。

### AHP 的流程

1. **选择指标**，构建层次模型，并构建**比较矩阵**。
2. 对每个比较矩阵计算CR值检验是否通过CR检验，**如果没有通过检验需要调整比较矩阵**。
3. 通过比较矩阵计算权重
4. 根据权重向量计算得分，并排序。

#### （1）构造判断矩阵

判断矩阵是，根据重要程度将层次结构模型中同一层次的要素相对于上层的某个因素，相互之间成对比较而形成的矩阵。假定 $A$ 层中元素 $A_k$ 与下一层 $n$ 个元素 $A_1,A_2,...,A_n$ 有关联，构造的判断矩阵如下

$$
\mathbf{B}=\begin{pmatrix}
b_{11}&\ldots&b_{1n}\\
\vdots&\ddots&\vdots\\
b_{n1}&\cdots&b_{nn}
\end{pmatrix}
$$

- $b_{ij}$ 表示对 $A_k$ 而言，$B_i$ 对 $B_j$ 相对重要性的数值表现。通常使用 1-9 表示法。

| 标度    | 含义                           |
| ------- | ------------------------------ |
| 1       | 两元素同等重要                 |
| 3       | 前一个元素比后一个元素稍微重要 |
| 5       | 前一个元素比后一个元素明显重要 |
| 7       | 前一个元素比后一个元素强烈重要 |
| 9       | 前一个元素比后一个元素绝对重要 |
| 2,4,6,8 | 上述两个标度的中值             |

判断矩阵要有如下性质：

- $b_{ij}*b_{ji} = 1$
- $b_{ii}=1$

#### （2）计算 CR

首先需要计算**特征向量和特征值**

$CR$ 计算公式

$$
CR=\frac{CI}{RI}
$$

其中

$$
CI=\frac{\lambda_{max}-n}{n-1}
$$

| n            | 1    | 2    | 3    | 4    | 5    | 6    | 7    |
| ------------ | ---- | ---- | ---- | ---- | ---- | ---- | ---- |
| **RI** | 0    | 0    | 0.52 | 0.89 | 1.12 | 1.26 | 1.32 |
| **n**  | 8    | 9    | 10   | 11   | 12   | 13   | 14   |
| **RI** | 1.41 | 1.46 | 1.49 | 1.52 | 1.54 | 1.56 | 1.58 |

#### （3）计算权重

单一对比矩阵的权重向量用 最大特征向量对应的特征矩阵表示，权重归一化公式，使用**概率归一化**。

## （4）权重融合，计算得分

将多层权重对应融合，得到最终得分，按照得分排序。权重融合时用对应的上级权重乘下级权重，相当于对下级权重赋值。

$$
W_{new}=w_{upper}*W_{lower}
$$

其中

- $w_{upper}$ 代表上层权重向量中的对应值
- $W_{lowwer}$ 代表下次权重向量

## 7.2 熵权分析法

熵权法（Entropy Weight Method, EWM）是一种客观赋权方法，基于信息论的理论基础，根据各指标的数据的分散程度，利用信息熵计算并修正得到各指标的熵权，较为客观。相对而言这种数据驱动的方法就回避了上面主观性因素造成的重复修正的影响。

### 7.2.1 什么是信息熵

假设 $x$ 表示事件 $X$ 可能发生的某种情况，$p(x)$ 表示**这种情况发生的概率**我们可以定义 $I(x)=-\ln(p(x))$。因为 $0 \leq p ( x ) \leq 1$，所以 $I(x)\geq 0$。

如果事件 $X$ 一共有 $x_1, x_2, \cdots, x_n$ 这 $n$ 种情况，那么事件 $X$ 的信息熵为:

$$
H(X)=\sum_{i=1}^n[p(x_i)I(x_i)]=-\sum_{i=1}^n[p(x_i)\ln(p(x_i))]
$$

并且当 $p(x_1)=p(x_1)=\cdots=p(x_n)=1/n$ 时，$H(X)=\ln(n)$，取得最大值。

### 7.2.1 熵权分析法的原理

衡量方案好坏的指标有多种性质，有些指标越大越好，称为效益性指标；有些指标越小越好，称为成本型指标；有些指标越接近特定值越好，称为目标性指标；有些指标越接近特定区间越好，称为范围性指标。

若模型未经数据预处理直接计算，可能出现问题。因此，第一步是指标正向化。它涉及将原本的负向指标转为正向指标，例如将死亡率转为生存率、故障率转为可靠度。通过正向化，目标或结果的达成情况更直观，提高指标的可解释性和可操作性。

#### 正向化

正向化：就是将指标值转换效益指标。

- 对于效益型指标：不需要正向化。只需要通过 min-max规约 或 Z-score规约 进行规约即可。
- 对于成本型指标：它的正向化方式比较简单，可以取相反数；如果指标全部为正数，也可以取其倒数。
- 对于区间型指标：它的规约方法遵循下面的式子。
  $$
  x_{new}=
  \begin{cases}
  1-\frac{a-x}{{M}} &, x < a\\
  1 &, a \le x \le b\\
  1-\frac{x-b}{M} &, x > b
  \end{cases}
  $$
- 对于中值型指标：它的正向化操作为
  $$
  x_{new}=1-\frac{\left|x-x\right._{best}|}{max\left(\left|x-x\right._{best}\right|)}
  $$

在进行指标正向化以后，所有的指标全部被变换**效益指标**。而为了进一步消除量纲这些的影响，需要进一步进行min-max规约化或z-score规约化消除量纲差异。

#### 熵权法的主要计算步骤如下

1. 构建 $m$ 个事物 $n$ 个指标的矩阵 $X_{m\times n}$
2. 将判断矩阵进行归一化处理，得到新的归一化判断矩阵$X_{m\times n}$。
   $$
   x_{ij}=\frac{x_{ij}-\min ( x_{j} ) }{\max ( x_{j} ) - \min ( x_{j} )  }
   $$
3. 计算每个评价指标的权重矩阵 $P_{m\times n}$
   $$
   p_{ij}=\frac{b_{ij}}{\sum_{i=1}^{m}b_{ij}}
   $$
4. 根据信息论中对熵的定义，计算熵值向量 $E_{n}$
   $$
   e_j=-\frac{1}{\ln m}\sum_{i=1}^mp_{ij}\ln p_{ij}
   $$
5. 计算每个指标的权重系数向量 $W_n$
   $$
   _j=\frac{1-e_j}{\sum_{i=1}^n(1-e_j)}
   $$

> 注意：熵权法是一个数据驱动过程，一定要保证有一定数据量并且做了正向化。

### 7.3.1 TOPSIS分析法

TOPSIS法（Technique for Order Preference by Similarity to Ideal Solution）可翻译为逼近理想解排序法，国内常简称为优劣解距离法。

在TOPSIS分析法中，我们通过计算每个方案离理想解和负理想解的距离来判断优劣。理想解是最佳方案，各项指标最优；负理想解是最差方案，各项指标最差。这种方法就像“近朱者赤近墨者黑”，离最好的方案越近，表现就越优秀，离最差的方案越远，表现就越差。

#### 计算距离的多种方式

欧几里得距离、曼哈顿距离、余弦距离。

$$
Euclidean\left(x,y\right)=\sqrt{\sum_{i=1}^n{(x_i-y_i)^2}}
$$

$$
Manhaton\left(x,y\right)=\sum_{i=1}^n|x_i-y_i|
$$

$$
cos\left(x,y\right)=\frac{x^Ty}{|x||y|}
$$

可以用来计算距离得分，记为 $distance(x,y)$

TOPSIS法的基本流程如下：

1. 将原始矩阵正向化，归一化
2. 根据准则的重要性，对矩阵进行加权
3. 确定正理想解 $Z^+=\max\limits_{j\in J} z_{ij}$ 和负理想解 $Z^-=\min\limits_{j\in J} z_{ij}$
4. 分别计算距离得分 $D_+^i=distance(z_{ij},Z^j_+)$ 和 $D_-^i=distance(z_{ij},Z^j_-)$
5. 计算贴近度（得分）$W_i=\frac{D_-^i}{D_-^i+D_+^i}$

贴进度是与负理想解和两个理想解距离之和的比值，若占比越大，则说明离负理想解越远，越优先选择。

## 参考

- [用人话讲明白AHP层次分析法（非常详细原理+简单工具实现）](https://blog.csdn.net/qq_41686130/article/details/122081827)
- [AHP（层次分析法）学习笔记及多层权重Python实践_ahp权重-CSDN博客](https://blog.csdn.net/xiaoyw71/article/details/108415148)
